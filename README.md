（本文基于公开数学原理和案例，仅供学习参考，非投资建议。）

一、凯利公式的基本原理：在风险和利润之间找到一个平衡点

凯利公式最早由约翰·凯利在1956年提出，本质上是为了解决一个问题：在有不确定性的机会面前，你应该投入多少资源，才能让你的财富长期增长最快，同时避免过度冒险？

简单来说，凯利公式计算的是你应该投入总资金的比例（记作f）。它的经典形式是：

f = (p*b - q) / b

其中：

p：成功的概率（比如你认为投资成功的概率是0.6）。

q：失败的概率（q = 1 - p）。

b：成功的回报比例（净收益相对于投入的倍数，比如成功后赚1倍，b=1）。

这个公式的核心思想是最大化财富的对数增长率。为什么用对数？因为对数函数能平衡收益和风险：它奖励稳定的增长，避免一夜暴富后瞬间崩盘的极端情况。

推导思路也很直观：假设你有初始资金W，投入比例f。

成功时，资金变成W (1 + f*b)。

失败时，资金变成W (1 - f)。 预期增长率用对数表示：G(f) = p ln(1 + f*b) + q *n(1 - f)。 通过求导找到G(f)最大时的f，就得到了上面的公式。

二、经典凯利公式的推导过程

问题设定

：假设你有初始资金W，每次投入比例f（比如f=0.2，投入20%）。投资结果有两种：

成功（概率p）：资金变成W (1 + f b)，因为赚了投入金额f W的b倍。

失败（概率q=1-p）：资金变成W (1 - f)，因为投入全亏。

目标

：最大化财富的长期增长率。长期增长可以用

预期对数增长率

表示。单次投资后的预期对数增长为： G(f) = p ln(1 + f b) + q ln(1 - f)

这里，ln是自然对数，G(f)衡量财富增长的“质量”。我们需要找到f，让G(f)最大。

求导找最大值

：要让G(f)最大，对f求导并令导数为0：

令G'(f) = 0： p*b / (1 + f*b) = q / (1 - f)

第一项p*ln(1 + f b)的导数：p * (b / (1 + f b))。

第二项q*ln(1 - f)的导数：q * (-1 / (1 - f))。

总导数：G'(f) = p*b / (1 + f*b) - q / (1 - f)。

解方程

：交叉相乘： p*b (1 - f) = q*(1 + f*b)

展开： p*b - p*b*f = q + q*f*b

把含f的项移到一边： p*b - q = p*b*f + q*f*b

提取f： p*b - q = f (p*b + q*b)

因为p + q = 1，p*b + q*b = b (p + q) = b，所以： f = (p*b - q) / b

三、经典凯利公式的案例

（本文基于公开数学原理和案例，仅供学习参考，非投资建议。）

来看个实际例子。假设你有10000元，想投资一只A股，经过分析：

成功概率p=0.6（60%概率股价上涨）。

失败概率q=0.4。

成功时净回报b=1（赚相当于投入金额的1倍）。

代入公式： f = (0.6 * 1 - 0.4) / 1 = 0.2

你应该投入20%的资金，即2000元。长期坚持这个比例，能让你的资金稳步增长。如果全投，可能一次失败就损失惨重；如果只投100元，增长太慢。凯利公式帮你找到平衡点。

再看一个例子：如果回报更高，b=2（成功赚2倍），p=0.5，q=0.5： f = (0.5 * 2 - 0.5) / 2 = 0.25

你应该投入25%的资金。这说明，高回报允许稍多投入，但仍需谨慎。此公式仅可计算理想情况。

四、简单扩展凯利公式

经典凯利公式假设失败时损失全部投入，但现实中，投资失败往往只亏一部分（比如某股票下降20%）。这时候，我们需要扩展凯利公式来适应部分收益和部分损失的场景。

扩展公式是：

f = (p b - q a) / (a b)

新增了一个变量：

a ：失败时的损失比例（比如亏20%，a=0.2）。

推导过程

：

财富变化

：投入比例f，成功时资金变成W (1 + f b)，失败时变成W (1 - f a)。

预期对数增长

：G(f) = p ln(1 + f b) + q ln(1 - f a)。

求导

：对f求导：

令G'(f) = 0： p b / (1 + f b) = q a / (1 - f a)

第一项：p * (b / (1 + f b))。

第二项：q * (-a / (1 - f a))。

总导数：G'(f) = p b / (1 + f b) - q a / (1 - f a)。

解方程

：交叉相乘： p b (1 - f a) = q a (1 + f b)

展开： p b - p b f a = q a + q a f b

整理： p b - q a = f (p b a + q a b)

因为p b a + q a b = a b (p + q) = a b，所以： f = (p b - q a) / (a b)



五、利用扩展公式进行计算

你在某模拟股票市场分析一只股票，估计：

成功概率p=0.6，赚30%（b=0.3）。

失败概率q=0.4，亏10%（a=0.1）。

代入公式： f = (0.6 * 0.3 - 0.4 * 0.1) / (0.1 * 0.3) = (0.18 - 0.04) / 0.03 ≈ 4.67

结果f=4.67，说明机会很好，但你不可能投入4.67倍资金。所以根据公式指示建议全投（f=1）或保守点投70%（7000元），留余地应对波动。







（图为基于凯利扩展和传统算法的指数计算器，已开源至Github）

